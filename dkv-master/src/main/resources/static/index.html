<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åˆ†å¸ƒå¼é”®å€¼å¯¹é›†ç¾¤ç›‘æ§ä»ªè¡¨ç›˜</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.1/echarts.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 2rem; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 12px; margin-bottom: 1.5rem; }
        .node-badge { font-size: 0.9rem; margin-right: 0.5rem; background-color: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        #ring-chart { height: 400px; width: 100%; }
        .result-box { background: #fdfdfe; border-left: 4px solid #4caf50; padding: 1rem; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
        <span class="fs-4 fw-bold text-primary">ğŸ›°ï¸ Mini-DKV Master Console</span>
        <span id="update-time" class="text-muted small">æœ€åæ›´æ–°: --:--:--</span>
    </header>

    <div class="row">
        <div class="col-lg-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title fw-bold">ğŸ–¥ï¸ å½“å‰åœ¨çº¿ DataNodes</h5>
                    <hr>
                    <div id="nodes-container" class="d-flex flex-wrap gap-2">
                        <span class="text-muted">æ­£åœ¨æ£€ç´¢é›†ç¾¤çŠ¶æ€...</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title fw-bold">ğŸ” è·¯ç”±æ¨¡æ‹Ÿå™¨</h5>
                    <p class="card-text small text-muted">è¾“å…¥ Key æ¨¡æ‹Ÿä¸€è‡´æ€§å“ˆå¸Œè·¯ç”±è¿‡ç¨‹</p>
                    <div class="input-group mb-3">
                        <input type="text" id="key-input" class="form-control" placeholder="è¾“å…¥ Key (å¦‚: user_id_1001)">
                        <button class="btn btn-primary" onclick="queryRoute()">æŸ¥è¯¢è·¯ç”±</button>
                    </div>
                    <div id="route-result" class="result-box d-none">
                        <div class="small text-muted mb-1">è·¯ç”±ç»“æœï¼š</div>
                        <div class="mb-2"><strong>ä¸»èŠ‚ç‚¹:</strong> <span id="res-primary" class="badge bg-success"></span></div>
                        <div><strong>å‰¯æœ¬èŠ‚ç‚¹:</strong> <div id="res-replicas" class="mt-1"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title fw-bold">ğŸ¡ ä¸€è‡´æ€§å“ˆå¸Œç¯åˆ†å¸ƒ</h5>
                    <div id="ring-chart"></div>
                    <p class="small text-center text-muted">å±•ç¤ºç‰©ç†èŠ‚ç‚¹åœ¨å“ˆå¸Œç©ºé—´ä¸­çš„è¦†ç›–æ¯”ä¾‹</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let myChart = echarts.init(document.getElementById('ring-chart'));

    // 1. å®šæ—¶åˆ·æ–°èŠ‚ç‚¹åˆ—è¡¨å’Œå›¾è¡¨
    function refreshStatus() {
        fetch('/api/nodes')
            .then(res => res.json())
            .then(nodes => {
                updateNodeList(nodes);
                updateChart(nodes);
                document.getElementById('update-time').innerText = 'æœ€åæ›´æ–°: ' + new Date().toLocaleTimeString();
            });
    }

    function updateNodeList(nodes) {
        const container = document.getElementById('nodes-container');
        if (nodes.length === 0) {
            container.innerHTML = '<span class="text-danger small">è­¦å‘Š: é›†ç¾¤å†…æš‚æ— å¯ç”¨èŠ‚ç‚¹</span>';
            return;
        }
        container.innerHTML = nodes.map(ip => `<span class="badge node-badge">ğŸ–¥ï¸ ${ip}</span>`).join('');
    }

    function updateChart(nodes) {
        // æ¨¡æ‹Ÿå„èŠ‚ç‚¹åœ¨ç¯ä¸Šçš„å‡åŒ€åˆ†å¸ƒï¼ˆä»…ä¸ºç¤ºæ„å›¾ï¼Œå±•ç¤ºèŠ‚ç‚¹å æ¯”ï¼‰
        const data = nodes.map(ip => ({ name: ip, value: 1 }));
        const option = {
            tooltip: { trigger: 'item' },
            legend: { bottom: '5%', left: 'center' },
            series: [{
                name: 'å“ˆå¸Œç©ºé—´å æ¯”',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                label: { show: false },
                data: data.length > 0 ? data : [{name: 'æ— èŠ‚ç‚¹', value: 1, itemStyle: {color: '#eee'}}]
            }]
        };
        myChart.setOption(option);
    }

    // 2. æŸ¥è¯¢è·¯ç”±é€»è¾‘
    function queryRoute() {
        const key = document.getElementById('key-input').value;
        if(!key) return;

        fetch(`/api/route?key=${key}`)
            .then(res => res.json())
            .then(data => {
                const resBox = document.getElementById('route-result');
                resBox.classList.remove('d-none');

                document.getElementById('res-primary').innerText = data.primary;
                const replicasDiv = document.getElementById('res-replicas');
                replicasDiv.innerHTML = data.replicas.map(ip => `<span class="badge bg-secondary me-1">${ip}</span>`).join('') || '<span class="text-muted small">æ— å¤‡ç”¨å‰¯æœ¬</span>';
            });
    }

    // åˆå§‹åŒ–è¿è¡Œ
    refreshStatus();
    setInterval(refreshStatus, 3000); // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
    window.addEventListener('resize', () => myChart.resize());
</script>

</body>
</html>