<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Mini-DKV å…¨åŠŸèƒ½ç®¡ç†ç³»ç»Ÿ - ç«–å‘ç‰ˆ</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.1/echarts.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, sans-serif; padding-bottom: 3rem; }
        .main-header { background: #fff; border-bottom: 1px solid #e0e0e0; padding: 1rem 2rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* å¡ç‰‡ç»Ÿä¸€æ ·å¼ */
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 1.5rem; overflow: hidden; }
        .card-header { background: transparent; border-bottom: 1px solid #f0f0f0; padding: 1.25rem 1.5rem; display: flex; align-items: center; justify-content: space-between; }
        .card-title { font-weight: 700; color: #333; margin: 0; font-size: 1.15rem; }

        /* èŠ‚ç‚¹çŠ¶æ€æ ·å¼ */
        .node-badge { background: #eef2ff; color: #4338ca; border: 1px solid #e0e7ff; padding: 8px 16px; border-radius: 10px; font-weight: 500; transition: all 0.2s; }
        .node-badge:hover { background: #e0e7ff; transform: translateY(-2px); }

        /* å›¾è¡¨å®¹å™¨ */
        #ring-chart { height: 400px; width: 100%; }

        /* æ§åˆ¶å°æ ·å¼ */
        .console-wrapper { background: #1e1e1e; border-radius: 12px; padding: 20px; position: relative; }
        .result-box { color: #d4d4d4; font-family: 'Fira Code', 'Consolas', monospace; font-size: 0.95rem; height: 250px; overflow-y: auto; line-height: 1.6; }
        .result-box .cmd { color: #569cd6; }
        .result-box .success { color: #4ec9b0; }
        .result-box .error { color: #f44747; }

        /* æŒ‰é’®ç»„ */
        .action-btns .btn { padding: 12px; font-weight: 600; border-radius: 10px; transition: all 0.2s; }
        .action-btns .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
    </style>
</head>
<body>

<header class="main-header d-flex justify-content-between align-items-center">
    <span class="fs-4 fw-bold text-primary">ğŸ›°ï¸ Mini-DKV Master & Client Console</span>
    <div id="update-time" class="text-muted small">æœ€ååŒæ­¥: --:--:--</div>
</header>

<div class="container mt-4">
    <div class="row">

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">ğŸ–¥ï¸ èŠ‚ç‚¹çŠ¶æ€ä¸ç®¡ç†</h5>
                    <span class="badge bg-success opacity-75">å®æ—¶è¿æ¥</span>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-7 border-end">
                            <label class="form-label text-muted small fw-bold mb-3">å½“å‰åœ¨çº¿èŠ‚ç‚¹</label>
                            <div id="nodes-container" class="d-flex flex-wrap gap-2">
                                <span class="text-muted">æ­£åœ¨æ£€ç´¢é›†ç¾¤çŠ¶æ€...</span>
                            </div>
                        </div>
                        <div class="col-md-5 ps-md-4 mt-3 mt-md-0">
                            <label class="form-label text-muted small fw-bold mb-3">æ‰‹åŠ¨ç®¡ç†</label>
                            <div class="input-group mb-2">
                                <input type="text" id="node-ip" class="form-control" placeholder="IP (127.0.0.1)">
                                <input type="number" id="node-port" class="form-control" style="max-width: 100px;" placeholder="ç«¯å£">
                                <button class="btn btn-primary" onclick="manageNode('addtozk')">æ³¨å†Œ</button>
                                <button class="btn btn-outline-danger" onclick="manageNode('delete')">ä¸‹çº¿</button>
                            </div>
                            <div id="manage-msg" class="small text-end"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">âš¡ æ•°æ®æ“ä½œæ§åˆ¶å°</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">KEY</label>
                                <input id="kv-key" type="text" class="form-control form-control-lg bg-light" placeholder="e.g. user_101">
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">VALUE</label>
                                <textarea id="kv-value" class="form-control bg-light" rows="4" placeholder="JSON æˆ– æ–‡æœ¬å†…å®¹..."></textarea>
                            </div>
                            <div class="action-btns d-grid gap-2">
                                <div class="row g-2">
                                    <div class="col-6"><button class="btn btn-primary w-100" onclick="kvOp('get')">è¯»å– (GET)</button></div>
                                    <div class="col-6"><button class="btn btn-success w-100" onclick="kvOp('save')">å†™å…¥ (PUT)</button></div>
                                </div>
                                <button class="btn btn-danger w-100" onclick="kvOp('delete')">åˆ é™¤ (DELETE)</button>
                            </div>
                        </div>
                        <div class="col-md-8 ps-md-4 mt-3 mt-md-0">
                            <label class="form-label fw-bold text-muted">CONSOLE OUTPUT</label>
                            <div class="console-wrapper">
                                <div class="result-box" id="kv-result">
                                    <span class="cmd">> Waiting for instructions...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">ğŸ¡ ä¸€è‡´æ€§å“ˆå¸Œå¯è§†åŒ–</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <div id="ring-chart"></div>
                        </div>
                        <div class="col-md-5 ps-md-5">
                            <div class="p-4 bg-light rounded-4">
                                <h6 class="fw-bold mb-3">ğŸ” è·¯ç”±æ¨¡æ‹Ÿè¿½è¸ª</h6>
                                <p class="text-muted small">æ¨¡æ‹Ÿ Key åœ¨ç¯ä¸Šçš„è½ç‚¹ç‰©ç†èŠ‚ç‚¹</p>
                                <div class="input-group mb-4">
                                    <div class="input-group mb-4">
                                        <input type="text" id="route-key" class="form-control border-primary" placeholder="è¾“å…¥æµ‹è¯• Key" style="flex: 2;">

                                        <span class="input-group-text bg-light text-muted small">å‰¯æœ¬æ•°</span>
                                        <input type="number" id="route-replicas" class="form-control border-primary" value="3" min="1" max="10" style="max-width: 80px;">

                                        <button class="btn btn-primary px-4" onclick="queryRoute()">è¿½è¸ª</button>
                                    </div>
                                </div>
                                <div id="route-result" class="d-none animate__animated animate__fadeIn">
                                    <div class="small text-muted mb-1">ç›®æ ‡ä¸»èŠ‚ç‚¹ (Primary):</div>
                                    <div class="h4 text-primary fw-bold" id="res-primary">--</div>
                                </div>
                                <div>
                                    <small class="text-muted d-block text-start">å‰¯æœ¬èŠ‚ç‚¹ (Secondary):</small>
                                    <div id="res-secondary" class="mt-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // é€»è¾‘éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œç¡®ä¿ api è·¯å¾„æ­£ç¡®
    const MASTER_API = "/api";
    const CLIENT_API = "http://127.0.0.1:8082/api/kv";
    let myChart = echarts.init(document.getElementById('ring-chart'));
    const STORAGE_API = "http://127.0.0.1:8085";

    function refreshStatus() {
        fetch(`${MASTER_API}/nodes`)
            .then(res => res.json())
            .then(nodes => {
                updateNodeList(nodes);
                updateChart(nodes);
                document.getElementById('update-time').innerText = 'æœ€ååŒæ­¥: ' + new Date().toLocaleTimeString();
            });
    }

    function updateNodeList(nodes) {
        const container = document.getElementById('nodes-container');
        container.innerHTML = nodes.map(ip => `<span class="node-badge">ğŸ–¥ï¸ ${ip}</span>`).join('') || '<span class="text-danger">é›†ç¾¤æ— å¯ç”¨èŠ‚ç‚¹</span>';
    }

    function updateChart(nodes) {
        const data = nodes.map(ip => ({ name: ip, value: 1 }));
        myChart.setOption({
            tooltip: { trigger: 'item' },
            series: [{
                type: 'pie', radius: ['55%', '85%'],
                itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 4 },
                label: { show: false },
                data: data.length > 0 ? data : [{name: 'Empty', value: 1, itemStyle: {color: '#f0f0f0'}}]
            }]
        });
    }

    function kvOp(type) {
        const key = document.getElementById("kv-key").value;
        const value = document.getElementById("kv-value").value;
        const resBox = document.getElementById("kv-result");

        if (!key) return;

        let url = `${CLIENT_API}/${type}?key=${key}`;
        if (type === 'save') url += `&value=${encodeURIComponent(value)}`;

        resBox.innerHTML += `<div class="cmd mt-2">> [${type.toUpperCase()}] ${key}</div>`;

        fetch(url, { method: (type === 'save' ? 'POST' : (type === 'delete' ? 'DELETE' : 'GET')) })
            .then(res => res.text())
            .then(data => {
                resBox.innerHTML += `<div class="success">Response: ${data}</div>`;
                resBox.scrollTop = resBox.scrollHeight;

                // å¦‚æœæ˜¯å†™å…¥æ“ä½œï¼Œè°ƒç”¨ sendClientRequest å‘ä¸»èŠ‚ç‚¹å‘é€è¯·æ±‚
                if (type === 'save') {
                    sendClientRequest();
                }
            })
            .catch(err => {
                resBox.innerHTML += `<div class="error">Error: ${err}</div>`;
            });
    }


    function queryRoute() {
        const key = document.getElementById('route-key').value;
        const replicas = document.getElementById('route-replicas').value || 3;

        if (!key) return;

        // è·å–è·¯ç”±ä¿¡æ¯
        fetch(`${MASTER_API}/route?key=${key}&replicas=${replicas}`)
            .then(res => res.json())
            .then(data => {
                const resultDiv = document.getElementById('route-result');
                resultDiv.classList.remove('d-none');

                // è·å– primary èŠ‚ç‚¹å¹¶æ‹†åˆ†ä¸º host å’Œ port
                const [host, port] = data.primary.split(':');
                const replicas = data.replicas;

                document.getElementById('res-primary').innerText = `${host}:${port}`;

                // æ˜¾ç¤ºå‰¯æœ¬èŠ‚ç‚¹
                const secondaryContainer = document.getElementById('res-secondary');
                if (secondaryContainer) {
                    if (data.secondary && data.secondary.length > 0) {
                        secondaryContainer.innerHTML = data.secondary
                            .map(node => `<span class="badge bg-secondary me-1" style="font-size: 0.9rem; margin-top: 5px;">${node}</span>`)
                            .join('');
                    } else {
                        secondaryContainer.innerHTML = '<span class="text-muted small">æ— å¯ç”¨å‰¯æœ¬èŠ‚ç‚¹</span>';
                    }
                }

                // è¿”å›çš„ primary å’Œ replicas å·²ç»å¤„ç†ï¼Œå¯ä»¥ç”¨äºåç»­çš„å®¢æˆ·ç«¯æ“ä½œ
                console.log('Primary node:', { host, port });
                console.log('Replicas:', replicas);

                // å¯ä»¥å°† host, port å’Œ replicas æ•°ç»„ç”¨äºåç»­æ“ä½œ
            })
            .catch(err => {
                console.error("è·¯ç”±æŸ¥è¯¢å¤±è´¥:", err);
                alert("è·¯ç”±æŸ¥è¯¢è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨");
            });
    }

    function manageNode(action) {
        const ip = document.getElementById('node-ip').value;
        const port = document.getElementById('node-port').value;
        const nodeId = `${ip}:${port}`;  // åˆ›å»º nodeId ä¸º ip+port

        if (action === 'addtozk') {
            // 1. æ„å»ºè¯·æ±‚ä½“ (Agent å’Œ Master å…±ç”¨å¤§éƒ¨åˆ†å‚æ•°)
            const requestBody = {
                nodeId:nodeId,
                host: ip,
                port: parseInt(port),
                dataDir: "F:\\javaProject\\distributedKeyValue\\data\\" + ip+"_"+port,
                isPrimary: true,
                replicas: "",
                addToRing: true,
                action: 'start' // Agent éœ€è¦è¿™ä¸ªå­—æ®µï¼ŒMaster ä¼šå¿½ç•¥å®ƒ
            };

            // ---------------------- ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨ Agent å¯åŠ¨ç‰©ç†èŠ‚ç‚¹ ----------------------
            fetch(`${STORAGE_API}/agent/command`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
                .then(response => response.json()) // è§£æ Agent çš„å“åº”
                .then(agentData => {
                    // 2. æ£€æŸ¥ Agent æ˜¯å¦å¯åŠ¨æˆåŠŸ
                    if (agentData.success === true) {
                        console.log('Agent å¯åŠ¨æˆåŠŸï¼Œå‡†å¤‡å‘ Master æ³¨å†Œ...', agentData);

                        // ------------------ ç¬¬äºŒæ­¥ï¼šè°ƒç”¨ Master æ³¨å†Œ ZK ------------------
                        // æ³¨æ„ï¼šè¿™é‡Œ return å¦ä¸€ä¸ª fetch Promiseï¼Œä»¥ä¾¿é“¾å¼è°ƒç”¨
                        return fetch(`${MASTER_API}/datanode/start-and-join-zk`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody) // ç›´æ¥å¤ç”¨å‚æ•°ï¼ŒMaster ä¼šè¯»å– host/port ç­‰å­—æ®µ
                        });
                    } else {
                        // å¦‚æœ Agent å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œè·³è¿‡åç»­çš„ thenï¼Œç›´æ¥è¿›å…¥ catch
                        throw new Error("Agent å¯åŠ¨å¤±è´¥: " + (agentData.error || agentData.message));
                    }
                })
                .then(masterResponse => {
                    // 3. å¤„ç† Master çš„ HTTP çŠ¶æ€
                    if (!masterResponse.ok) {
                        return masterResponse.json().then(err => { throw err; });
                    }
                    return masterResponse.json(); // è§£æ Master çš„ JSON
                })
                .then(masterData => {
                    // 4. æœ€ç»ˆæ£€æŸ¥ Master çš„ä¸šåŠ¡é€»è¾‘æ˜¯å¦æˆåŠŸ
                    if (masterData.success) {
                        console.log('Master æ³¨å†ŒæˆåŠŸ', masterData);
                        alert("èŠ‚ç‚¹å¯åŠ¨å¹¶æ³¨å†ŒæˆåŠŸï¼");
                        refreshStatus(); // åˆ·æ–°é¡µé¢è¡¨æ ¼
                    } else {
                        throw new Error("Master æ³¨å†Œå¤±è´¥: " + masterData.message);
                    }
                })
                .catch(error => {
                    // 5. ç»Ÿä¸€é”™è¯¯æ•è·ï¼ˆæ— è®ºæ˜¯ Agent æŒ‚äº†ï¼Œè¿˜æ˜¯ Master æŒ‚äº†ï¼Œéƒ½ä¼šèµ°åˆ°è¿™é‡Œï¼‰
                    console.error('æ“ä½œæµç¨‹å¤±è´¥', error);
                    alert("æ“ä½œå¤±è´¥: " + (error.message || "æœªçŸ¥é”™è¯¯"));
                });

        } else if (action === 'delete') {
            // è°ƒç”¨åˆ é™¤èŠ‚ç‚¹æ¥å£
            fetch(`${MASTER_API}/delete?nodeip=${ip}&port=${port}`, {
                method: 'POST'
            }).then(() => {
                refreshStatus();
            });
        }
    }
    function sendClientRequest() {
        const key = document.getElementById('kv-key').value;
        const value = document.getElementById('kv-value').value;
        const resBox = document.getElementById("kv-result");

        if (!key) return;

        // è¿™é‡Œä½¿ç”¨å·²ç»æ‹†åˆ†çš„ primary å’Œ replicas
        // const primaryHost = "127.0.0.1";  // ä»ä¸Šä¸€æ­¥è·å¾—çš„ host
        // const primaryPort = "7007";  // ä»ä¸Šä¸€æ­¥è·å¾—çš„ port

        // å‘ primary èŠ‚ç‚¹å‘é€è¯·æ±‚
        const url = `${CLIENT_API}/save?key=${encodeURIComponent(key)}&value=${encodeURIComponent(value)}`;

        // resBox.innerHTML += `<div class="cmd mt-2">> å‘é€åˆ°ä¸»èŠ‚ç‚¹: ${primaryHost}:${primaryPort}</div>`;

        fetch(url, { method: 'POST' })
            .then(res => res.text())
            .then(data => {
                resBox.innerHTML += `<div class="success">Response: ${data}</div>`;
                resBox.scrollTop = resBox.scrollHeight;
            })
            .catch(err => {
                resBox.innerHTML += `<div class="error">Error: ${err}</div>`;
            });
    }


    refreshStatus();
    setInterval(refreshStatus, 3000);
    window.addEventListener('resize', () => myChart.resize());
</script>
</body>
</html>