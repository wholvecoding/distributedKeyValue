<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>节点详情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }

        /* key 按钮样式 */
        .key-btn {
            display: inline-block;
            padding: 6px 14px;
            margin: 6px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
            transition: all 0.2s;
        }

        .key-btn:hover {
            opacity: 0.85;
            transform: translateY(-1px);
        }

        .key-color-0 { background-color: #0d6efd; }
        .key-color-1 { background-color: #198754; }
        .key-color-2 { background-color: #6f42c1; }
        .key-color-3 { background-color: #fd7e14; }
        .key-color-4 { background-color: #20c997; }

        .key-value {
            margin: 6px 0 12px 10px;
            padding: 8px 12px;
            background: #ffffff;
            border-left: 4px solid #0d6efd;
            border-radius: 6px;
            display: none;
            font-family: monospace;
            box-shadow: 0 2px 6px rgba(0,0,0,.08);
        }
    </style>
</head>

<body class="p-4">

<h4 id="node-title">节点详情</h4>
<hr>

<!-- 节点列表 -->
<h5>当前分区节点</h5>
<div id="partition-nodes" class="mb-4 d-flex flex-wrap gap-2"></div>

<!-- 搜索 -->
<input id="key-search" class="form-control mb-3" placeholder="搜索 Key">

<!-- Key 列表 -->
<div id="key-container" class="d-flex flex-wrap"></div>

<script>
    const params = new URLSearchParams(window.location.search);
    const node = params.get("node");
    const API = "http://127.0.0.1:8081";

    document.getElementById("node-title").innerText = `节点详情：${node}`;

    let allKeys = [];

    /* ========== 节点列表 ========== */
    function loadPartitionNodes() {
        fetch(`${API}/api/node/getAll?node=${encodeURIComponent(node)}`)
            .then(res => res.json())
            .then(list => {
                const box = document.getElementById("partition-nodes");
                box.innerHTML = "";

                list.forEach(n => {
                    const span = document.createElement("span");
                    span.className = "badge " + (n === node ? "bg-danger" : "bg-secondary");
                    span.innerText = n === node ? `${n}（主）` : `${n}（从）`;
                    box.appendChild(span);
                });
            });
    }

    /* ========== Key 列表 ========== */
    function loadKeys() {
        fetch(`${API}/api/node/keyAll?node=${encodeURIComponent(node)}`)
            .then(res => res.json())
            .then(list => {
                allKeys = list;
                renderKeys();
            });
    }

    function renderKeys() {
        const keyword = document.getElementById("key-search").value.toLowerCase();
        const container = document.getElementById("key-container");
        container.innerHTML = "";

        allKeys
            .filter(item => item.toLowerCase().includes(keyword))
            .forEach((item, index) => {
                const [key, value] = item.split(":");

                const wrapper = document.createElement("div");

                const btn = document.createElement("div");
                btn.className = `key-btn key-color-${index % 5}`;
                btn.innerText = key;

                const valueBox = document.createElement("div");
                valueBox.className = "key-value";
                valueBox.innerText = value || "(空)";

                btn.onclick = () => {
                    valueBox.style.display =
                        valueBox.style.display === "block" ? "none" : "block";
                };

                wrapper.appendChild(btn);
                wrapper.appendChild(valueBox);
                container.appendChild(wrapper);
            });
    }

    document.getElementById("key-search").addEventListener("input", renderKeys);

    // 定时刷新
    setInterval(() => {
        loadPartitionNodes();
        loadKeys();
    }, 3000);

    loadPartitionNodes();
    loadKeys();
</script>

</body>
</html>
